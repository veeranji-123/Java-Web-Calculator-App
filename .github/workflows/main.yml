name: Java WebApp CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      MVN_SETTINGS: /home/runner/.m2/settings.xml
      SONAR_HOST_URL: http://52.10.29.223:9000
      NEXUS_URL: http://34.216.123.235:8081
      NEXUS_REPO: maven-releases
      NEXUS_GROUP: com/web/cal
      NEXUS_ARTIFACT: webapp-add
      TOMCAT_URL: http://54.202.187.150:8080/manager/text

    steps:
      # === Stage 1: Checkout Code ===
      - name: üì¶ Checkout repository
        uses: actions/checkout@v4

      # === Stage 2: Set up JDK & Maven ===
      - name: ‚òï Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: maven

      # === Stage 3: SonarQube Analysis ===
      - name: üîç SonarQube Scan
        env:
          SONAR_TOKEN: ${{ secrets.SONARQUB_TOKIN }}
        run: |
          echo "Running SonarQube analysis..."
          mvn clean verify sonar:sonar \
            -DskipTests \
            -Dsonar.projectKey=webapp-add \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.login=${SONAR_TOKEN}

      # === Stage 4: Build WAR ===
      - name: ‚öôÔ∏è Build WAR file
        run: |
          echo "Building WAR package..."
          mvn clean package -DskipTests
          ls -lh target/*.war

      # === Stage 5: Upload Artifact to Nexus ===
      - name: üì§ Upload WAR to Nexus
        env:
          NEXUS_USR: ${{ secrets.NEXUS_USERNAME }}
          NEXUS_PSW: ${{ secrets.NEXUS_PASSWORD }}
        run: |
          set -e
          WAR_FILE=$(ls target/*.war | head -1)
          VERSION="0.0.${{ github.run_number }}"
          echo "Uploading $WAR_FILE to Nexus..."
          curl -v -u ${NEXUS_USR}:${NEXUS_PSW} --upload-file "$WAR_FILE" \
            "${NEXUS_URL}/repository/${NEXUS_REPO}/${NEXUS_GROUP}/${NEXUS_ARTIFACT}/${VERSION}/${NEXUS_ARTIFACT}-${VERSION}.war"
          echo "‚úÖ Nexus upload successful!"

      # === Stage 6: Deploy to Tomcat ===
      - name: üöÄ Deploy to Tomcat
        env:
          NEXUS_USR: ${{ secrets.NEXUS_USERNAME }}
          NEXUS_PSW: ${{ secrets.NEXUS_PASSWORD }}
          TOMCAT_USR: ${{ secrets.TOMCAT_USERNAME }}
          TOMCAT_PSW: ${{ secrets.TOMCAT_PASSWORD }}
        run: |
          set -e
          echo "Fetching latest WAR from Nexus..."
          DOWNLOAD_URL=$(curl -s -u ${NEXUS_USR}:${NEXUS_PSW} \
              "${NEXUS_URL}/service/rest/v1/search?repository=${NEXUS_REPO}&group=com.web.cal&name=webapp-add" \
              | grep -oP '"downloadUrl"\s*:\s*"\K[^"]+\.war' | grep -vE '\.md5|\.sha1' | tail -1)

          if [[ -z "$DOWNLOAD_URL" ]]; then
            echo "‚ùå No WAR found in Nexus!"
            exit 1
          fi

          echo "‚¨áÔ∏è Downloading WAR from: $DOWNLOAD_URL"
          curl -u ${NEXUS_USR}:${NEXUS_PSW} -O "$DOWNLOAD_URL"
          WAR_FILE=$(basename "$DOWNLOAD_URL")
          APP_NAME=$(echo "$WAR_FILE" | sed 's/-[0-9].*//')

          echo "üßπ Removing old deployment..."
          curl -u ${TOMCAT_USR}:${TOMCAT_PSW} "${TOMCAT_URL}/undeploy?path=/${APP_NAME}" || true

          echo "üöÄ Deploying new WAR to Tomcat..."
          curl -u ${TOMCAT_USR}:${TOMCAT_PSW} --upload-file "$WAR_FILE" \
              "${TOMCAT_URL}/deploy?path=/${APP_NAME}&update=true"

          echo "‚úÖ Deployment successful ‚Äî App live on Tomcat!"

